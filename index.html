<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Open Geomatics Community of Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/css/style.css">
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background:#fafafa; }
    header { background:#0c3c78; color:white; padding:1.5rem; text-align:center; }
    main { max-width:1000px; margin:2rem auto; padding:0 1rem; }
    h1 { margin-top:0; }
    .filters { display:grid; gap:.75rem; grid-template-columns:1fr 1fr; }
    details { background:#fff; padding:.5rem; border-radius:.5rem; box-shadow:0 1px 2px rgba(0,0,0,.05); }
    input[type=search]{ width:100%; padding:.5rem; border-radius:.5rem; border:1px solid #ccc;}
    .facet label{display:inline-block;margin-right:.75rem;margin-bottom:.5rem;}
    .cards{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));margin-top:1rem;}
    .card{background:white;padding:1rem;border-radius:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.1);}
    .card h3{margin-top:0;}
    .pill{display:inline-block;padding:.1rem .5rem;border-radius:999px;background:#eef;margin:.1rem .25rem 0 0;font-size:.8rem;}
    footer{margin-top:3rem;text-align:center;color:#666;font-size:.85rem;padding:1rem 0;}
    @media(min-width:800px){.filters{grid-template-columns:2fr 1fr 1fr;}}
  </style>
</head>

<body>
<header>
  <h1>Open Geomatics Community of Practice</h1>
  <p>Explore open educational geomatics labs by topic, software, and Bloom’s level.</p>
</header>

<main>
  <section class="filters">
    <input id="q" type="search" placeholder="Search by title, summary, or keywords…">
    <details open>
      <summary>Themes</summary>
      <div id="facet-topics" class="facet"></div>
    </details>
    <details>
      <summary>Software</summary>
      <div id="facet-software" class="facet"></div>
    </details>
    <details>
      <summary>Bloom’s levels</summary>
      <div id="facet-bloom" class="facet"></div>
    </details>
    <button id="clear">Clear filters</button>
  </section>

  <div id="count" style="margin-top:1rem;color:#555;"></div>
  <div id="cards" class="cards"></div>
</main>

<footer>
  <p>&copy; 2025 Open Geomatics Community of Practice — CC-BY 4.0</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
(async function(){
  const res = await fetch("/assets/assignments.json");
  const data = await res.json();
  const items = data.items || [];

  // Build facet data
  const facets = { topics:new Map(), software:new Map(), bloom:new Map() };
  for(const it of items){
    (it.topics||[]).forEach(t=>facets.topics.set(t,1+(facets.topics.get(t)||0)));
    (it.software||[]).forEach(s=>facets.software.set(s,1+(facets.software.get(s)||0)));
    (it.blooms_levels||[]).forEach(b=>facets.bloom.set(b,1+(facets.bloom.get(b)||0)));
  }

  function renderFacet(container, map, name){
    container.innerHTML="";
    [...map.keys()].sort().forEach(val=>{
      const id=`${name}-${val.replace(/\s+/g,"-")}`;
      const lbl=document.createElement("label");
      lbl.innerHTML=`<input type="checkbox" value="${val}" id="${id}"> ${val}`;
      container.appendChild(lbl);
    });
  }

  renderFacet(document.getElementById("facet-topics"),facets.topics,"topics");
  renderFacet(document.getElementById("facet-software"),facets.software,"software");
  renderFacet(document.getElementById("facet-bloom"),facets.bloom,"bloom");

  const fuse = new Fuse(items,{
    keys:[
      {name:"title",weight:0.5},
      {name:"summary",weight:0.3},
      {name:"keywords",weight:0.2}
    ],
    threshold:0.35,
    ignoreLocation:true
  });

  const els={
    q:document.getElementById("q"),
    clear:document.getElementById("clear"),
    cards:document.getElementById("cards"),
    count:document.getElementById("count")
  };

  function selectedValues(selector){return [...document.querySelectorAll(selector+":checked")].map(c=>c.value);}

  function render(list){
    els.count.textContent=`${list.length} lab${list.length===1?"":"s"} found`;
    els.cards.innerHTML=list.map(it=>{
      const link = it.page_url || it.site_url || it.repo_url;
      const topics = (it.topics||[]).map(t=>`<span class="pill">${t}</span>`).join(" ");
      const software = (it.software||[]).map(s=>`<span class="pill">${s}</span>`).join(" ");
      const blooms = (it.blooms_levels||[]).map(b=>`<span class="pill">${b}</span>`).join(" ");
      return `<article class="card">
        <h3><a href="${link}" target="_blank" rel="noopener">${it.title}</a></h3>
        <p>${it.summary||""}</p>
        <div>${topics} ${software} ${blooms}</div>
        <small>${it.course_code||""}</small>
      </article>`;
    }).join("");
  }

  function applyFilters(){
    const q = els.q.value.trim();
    let base = q ? fuse.search(q).map(r=>r.item) : items.slice();
    const topics = selectedValues("#facet-topics input");
    const software = selectedValues("#facet-software input");
    const blooms = selectedValues("#facet-bloom input");
    if(topics.length) base = base.filter(it=>(it.topics||[]).some(t=>topics.includes(t)));
    if(software.length) base = base.filter(it=>(it.software||[]).some(s=>software.includes(s)));
    if(blooms.length) base = base.filter(it=>(it.blooms_levels||[]).some(b=>blooms.includes(b)));
    render(base);
  }

  document.getElementById("facet-topics").addEventListener("change",applyFilters);
  document.getElementById("facet-software").addEventListener("change",applyFilters);
  document.getElementById("facet-bloom").addEventListener("change",applyFilters);
  els.q.addEventListener("input",applyFilters);
  els.clear.addEventListener("click",()=>{
    document.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
    els.q.value="";
    render(items);
  });

  render(items);
})();
</script>
</body>
</html>
